# 스프링 시큐리티 기본 API & Filter 이해

## 01. 인증 API - 스프링 시큐리티 의존성 추가 
### 스프링 시큐리티 의존성 추가 시 일어나는 일들
- 시큐리티 초기화 작업 및 보안 설정 
- 1. 모든 요청은 인증되어야 자원에 접근 가능
- 2. 인증 방식은 폼 로그인 방식과 httpBasic 로그인 방식을 제공함. 
- 3. 기본 로그인 페이지 제공
- 4. 기본 계정 한 개 제공 - username: user / password : 랜덤문자열

## 02. 인증 API -  사용자 정의 보안 기능 구현 
![](img/img.png)
- SecurityConfig -상속-> WebSecurityConfigurerAdapter -> HttpSecurity -> 인증 & 인가 API
### SecurityConfig
- SecurityConfig: (사용자 정의)보안 설정 클래스
### WebSecurityConfigurerAdapter
- WebSecurityConfigurerAdapter: 시큐리티 웹보안 기능을 초기화하고 설정을 하는 클래스
### HttpSecurity
- HttpSecurity: WebSecurityConfigurerAdapter에 의해서 생성됨. 
- -> 세부적인 보안 기능을 설정할 수 있는 API를 제공
```java
@Configuration
@EnableWebSecurity // WebSecurityConfiguration 등의 클래스 추가
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception { //템플릿-콜백..?
        http // 인가
                .authorizeRequests() // 요청에 대한 보안 검사 시작됨
                .anyRequest().authenticated(); // 모든 요청에 대해 인증 받기
        http // 인증
                .formLogin(); //폼 로그린  
    }
}
```
```yml
# 패스워드 고정 설정
spring:
  security:
    user:
      name: user
      password: 1111
```

## 04. 인증 API - Form 인증
### 내부 처리 순서
![](img/img_1.png)
- 1. 클라이언트에서 요청 보냄
- 2. 요청에 인증이 안되면 로그인 페이지로 서버가 리다이렉트 시킴
- 3. 클라이언트에서 인증 요청 -> 서버에서 세션 및 인증 토큰 생성/저장 
- -> 서버에서 시큐리티가 세션을 생성, 인증객체(Authentication)및토큰 생성, 시큐리티 컨텍스트에 인증객체 저장, 시큐리티 컨텍스트 세션에 저장.   
- 4. 클라이언트에서 세션에 저장된 인증 토큰으로 접근 / 인증 유지 

### API 기능 - http.formLogin()  
- http.formLogin() -> form 로그인 인증 기능이 작동함  
```java
 protected void configure(HttpSecurity http) throws Exception {
    http.formLogin()
            .loginPage("/login.html") // 사용자 정의 로그인 페이지
            .defaultSuccessUrl("/home") // 로그인 성공 후 이동 페이지
            .failureUrl("/login.html?error=true") // 로그인 실패 후 이동 페이지
            .usernameParameter("username") // 아이디 파라미터명 설정
            .passwordParameter("password") // 패스워드 파라미터명 설정
            .loginProcessingUrl("/login") // 로그인 Form Action Url
            .successHandler(loginSuccessHandler()) // 로그인 성공 후 핸들러
            .failureHandler(loginFailureHandler()); // 로그인 실패 후 핸들러
}
```
```java
// 예시
@Override
protected void configure(HttpSecurity http) throws Exception { //템플릿-콜백..?
    http // 인가
            .authorizeRequests() // 요청에 대한 보안 검사 시작됨
            .anyRequest().authenticated(); // 모든 요청에 대해 인증 받기
    http // 인증
            .formLogin() //폼 로그린
            .loginPage("/loginPage")
            .defaultSuccessUrl("/")
            .failureUrl("/login")
            .usernameParameter("userId") //프론트와 맞춰야함
            .passwordParameter("passwd") //프론트와 맞춰야함
            .loginProcessingUrl("/login_proc") //프론트와 맞춰야함
            // AuthenticationSuccessHandler 구현체 콜백
            .successHandler(new AuthenticationSuccessHandler() {
                @Override
                public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
                    System.out.println("authentication " + authentication.getName());
                    response.sendRedirect("/");
                }
            })
            // AuthenticationFailureHandler 구현체 콜백
            .failureHandler(new AuthenticationFailureHandler() {
                @Override
                public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
                    System.out.println("exception " + exception.getMessage());
                    response.sendRedirect("/login");
                }
            })
            .permitAll(); // "/loginPage"에 접근하는 사용자는 모두 허용
}
```
